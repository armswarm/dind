platform: linux/arm

clone:
  git:
    image: armswarmdrone/git

pipeline:
  prepare:
    image: quay.io/armswarm/alpine:3.6
    environment:
      - ALPINE_VERSION=3.6
      - DOCKER_VERSION=17.05.0-ce
      - DOCKER_PACKAGE=17.05.0-r0
      - DIND_COMMIT=3b5fac462d21ca164b3778647420016315289034
    commands:
      - |-
          sed -i \
            -e "s/{{DOCKER_VERSION}}/${DOCKER_VERSION}/" \
            -e "s/{{DOCKER_PACKAGE}}/${DOCKER_PACKAGE}/" \
            -e "s/{{DIND_COMMIT}}/${DIND_COMMIT}/" \
            -e "s/{{ALPINE_VERSION}}/${ALPINE_VERSION}/" \
            Dockerfile dind/Dockerfile

  build_and_publish_docker_image:
    image: armswarmdrone/docker
    repo: quay.io/armswarm/docker
    tag: [ "17.05.0-ce", "17.05.0", "17.05", "17", "latest", "edge" ]
    when:
      branch: master
      event: push

  build_and_publish_dind_image:
    image: armswarmdrone/docker
    repo: quay.io/armswarm/docker
    context: dind/
    dockerfile: dind/Dockerfile
    tag: [ "17.05.0-ce-dind", "17.05.0-dind", "17.05-dind", "17-dind", "dind", "edge-dind" ]
    when:
      branch: master
      event: push

  notify:
    image: armswarmdrone/slack
    when:
      status: [ failure, success ]
